name: Build Debian
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Debian ${{ matrix.debian }} - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Debian 9 (Stretch) - Full support including old archs
          - debian: stretch
            arch: amd64
          - debian: stretch
            arch: i386
          - debian: stretch
            arch: armhf
          - debian: stretch
            arch: armel
          - debian: stretch
            arch: arm64
          - debian: stretch
            arch: armv7l
          
          # Debian 10 (Buster) - Full support including old archs
          - debian: buster
            arch: amd64
          - debian: buster
            arch: i386
          - debian: buster
            arch: armhf
          - debian: buster
            arch: armel
          - debian: buster
            arch: arm64
          - debian: buster
            arch: armv7l
          
          # Debian 11 (Bullseye) - NO armel support
          - debian: bullseye
            arch: amd64
          - debian: bullseye
            arch: i386
          - debian: bullseye
            arch: armhf
          - debian: bullseye
            arch: arm64
          - debian: bullseye
            arch: armv7l
          
          # Debian 12 (Bookworm) - NO armel support
          - debian: bookworm
            arch: amd64
          - debian: bookworm
            arch: i386
          - debian: bookworm
            arch: armhf
          - debian: bookworm
            arch: arm64
          - debian: bookworm
            arch: armv7l
          
          # Debian 13 (Trixie) - NO armel support
          - debian: trixie
            arch: amd64
          - debian: trixie
            arch: i386
          - debian: trixie
            arch: armhf
          - debian: trixie
            arch: arm64
          - debian: trixie
            arch: armv7l
          
          # Debian 14 (Forky) - Latest archs only
          - debian: forky
            arch: amd64
          - debian: forky
            arch: i386
          - debian: forky
            arch: armhf
          - debian: forky
            arch: arm64
          - debian: forky
            arch: armv7l
          
          # Debian 15 (Sid) - Latest archs only
          - debian: sid
            arch: amd64
          - debian: sid
            arch: i386
          - debian: sid
            arch: armhf
          - debian: sid
            arch: arm64
          - debian: sid
            arch: armv7l
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support debootstrap debian-archive-keyring

      - name: Create build directory
        run: |
          mkdir -p build/${{ matrix.debian }}-${{ matrix.arch }}
          mkdir -p artifacts

      - name: Build Debian rootfs
        run: |
          ARCH="${{ matrix.arch }}"
          if [[ "$ARCH" == "armv7l" ]]; then
            ARCH="armhf"
          fi
          MIRROR="http://deb.debian.org/debian"
          if [[ "${{ matrix.debian }}" == "stretch" ]] || [[ "${{ matrix.debian }}" == "buster" ]]; then
            MIRROR="http://archive.debian.org/debian"
          fi
          
          echo "Building Debian ${{ matrix.debian }} for ${{ matrix.arch }} (debootstrap arch: $ARCH)"
          echo "Using mirror: $MIRROR"
          
          # Stage 1: Bootstrap with --foreign for cross-arch
          if [[ "${{ matrix.debian }}" == "stretch" ]] || [[ "${{ matrix.debian }}" == "buster" ]]; then
            sudo debootstrap \
              --arch=$ARCH \
              --variant=minbase \
              --include=ca-certificates,locales \
              --foreign \
              --no-check-gpg \
              ${{ matrix.debian }} \
              build/${{ matrix.debian }}-${{ matrix.arch }} \
              $MIRROR
          else
            sudo debootstrap \
              --arch=$ARCH \
              --variant=minbase \
              --include=ca-certificates,locales \
              --foreign \
              ${{ matrix.debian }} \
              build/${{ matrix.debian }}-${{ matrix.arch }} \
              $MIRROR
          fi
          
          ROOTFS="build/${{ matrix.debian }}-${{ matrix.arch }}"
          
          # Copy QEMU static binary for second stage
          if [[ "$ARCH" == "armhf" ]] || [[ "$ARCH" == "armel" ]]; then
            sudo cp /usr/bin/qemu-arm-static $ROOTFS/usr/bin/
          elif [[ "$ARCH" == "arm64" ]]; then
            sudo cp /usr/bin/qemu-aarch64-static $ROOTFS/usr/bin/
          elif [[ "$ARCH" == "i386" ]]; then
            sudo cp /usr/bin/qemu-i386-static $ROOTFS/usr/bin/ || true
          fi
          
          # Stage 2: Complete the bootstrap inside chroot
          echo "Running second stage..."
          sudo chroot $ROOTFS /debootstrap/debootstrap --second-stage
          
      - name: Configure rootfs
        run: |
          ROOTFS="build/${{ matrix.debian }}-${{ matrix.arch }}"
          
          # Setup DNS
          echo "Setting up DNS..."
          sudo tee $ROOTFS/etc/resolv.conf > /dev/null <<EOF
          nameserver 8.8.8.8
          nameserver 8.8.4.4
          nameserver 1.1.1.1
          EOF
          
          # Setup APT sources
          echo "Setting up APT sources..."
          MIRROR="http://deb.debian.org/debian"
          if [[ "${{ matrix.debian }}" == "stretch" ]] || [[ "${{ matrix.debian }}" == "buster" ]]; then
            MIRROR="http://archive.debian.org/debian"
            sudo tee $ROOTFS/etc/apt/sources.list > /dev/null <<EOF
          deb $MIRROR ${{ matrix.debian }} main contrib non-free
          EOF
          else
            sudo tee $ROOTFS/etc/apt/sources.list > /dev/null <<EOF
          deb $MIRROR ${{ matrix.debian }} main contrib non-free non-free-firmware
          deb $MIRROR ${{ matrix.debian }}-updates main contrib non-free non-free-firmware
          deb http://security.debian.org/debian-security ${{ matrix.debian }}-security main contrib non-free non-free-firmware
          EOF
          fi
          
          # Configure locales
          sudo chroot $ROOTFS /bin/bash -c "echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen" || true
          sudo chroot $ROOTFS /bin/bash -c "locale-gen" || true
          
          # Add build info
          sudo tee $ROOTFS/etc/build-info.txt > /dev/null <<EOF
          Debian Version: ${{ matrix.debian }}
          Architecture: ${{ matrix.arch }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Built by: GitHub Actions
          Mirror: $MIRROR
          EOF
          
          # Cleanup
          sudo chroot $ROOTFS /bin/bash -c "apt-get clean" || true
          sudo rm -rf $ROOTFS/var/cache/apt/archives/*.deb
          sudo rm -rf $ROOTFS/tmp/*
          sudo rm -rf $ROOTFS/var/tmp/*
          
          # Remove QEMU static binary
          sudo rm -f $ROOTFS/usr/bin/qemu-*-static

      - name: Create tarball
        run: |
          cd build/${{ matrix.debian }}-${{ matrix.arch }}
          sudo tar czf ../../artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz .

      - name: Get tarball info
        run: |
          ls -lh artifacts/
          echo "Tarball created successfully"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-${{ matrix.debian }}-${{ matrix.arch }}
          path: artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find all-artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Debian Builds - Run ${{ github.run_number }}
          body: |
            # Debian Rootfs Builds
            
            ---
            
            ## ðŸ‡¬ðŸ‡§ English
            
            ### Supported Versions
            - **Debian 9** (Stretch) - Archived
            - **Debian 10** (Buster) - Archived
            - **Debian 11** (Bullseye) - Oldoldstable
            - **Debian 12** (Bookworm) - Oldstable
            - **Debian 13** (Trixie) - Testing
            - **Debian 14** (Forky) - Testing
            - **Debian 15** (Sid) - Unstable
            
            ### Architectures
            `amd64` `i386` `arm64` `armhf` `armel` `armv7l`
            
            ### Features
            - âœ… Fully bootstrapped with debootstrap second-stage
            - âœ… Pre-configured DNS (Google & Cloudflare)
            - âœ… APT sources ready to use
            - âœ… Locales configured (en_US.UTF-8)
            - âœ… Ready for chroot/container use
            
            ### Quick Start
            ```bash
            # Download
            wget https://github.com/YOUR-REPO/releases/download/TAG/debian-bookworm-arm64.tar.gz
            
            # Extract
            mkdir rootfs && tar xzf debian-bookworm-arm64.tar.gz -C rootfs
            
            # Use it (with QEMU for cross-arch)
            sudo chroot rootfs /bin/bash
            
            # Test basic commands
            ls /usr/bin
            apt update
            dpkg --version
            ```
            
            ---
            
            ## ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t
            
            ### CÃ¡c PhiÃªn Báº£n
            - **Debian 9** (Stretch) - ÄÃ£ lÆ°u trá»¯
            - **Debian 10** (Buster) - ÄÃ£ lÆ°u trá»¯
            - **Debian 11** (Bullseye) - Oldoldstable
            - **Debian 12** (Bookworm) - Oldstable
            - **Debian 13** (Trixie) - Testing
            - **Debian 14** (Forky) - Testing
            - **Debian 15** (Sid) - Unstable
            
            ### Kiáº¿n TrÃºc
            `amd64` `i386` `arm64` `armhf` `armel` `armv7l`
            
            ### TÃ­nh NÄƒng
            - âœ… Bootstrap hoÃ n chá»‰nh vá»›i debootstrap second-stage
            - âœ… DNS Ä‘Ã£ cáº¥u hÃ¬nh sáºµn (Google & Cloudflare)
            - âœ… APT sources sáºµn sÃ ng sá»­ dá»¥ng
            - âœ… Locales Ä‘Ã£ cÃ i Ä‘áº·t (en_US.UTF-8)
            - âœ… Sáºµn sÃ ng cho chroot/container
            
            ### HÆ°á»›ng Dáº«n Nhanh
            ```bash
            # Táº£i vá»
            wget https://github.com/YOUR-REPO/releases/download/TAG/debian-bookworm-arm64.tar.gz
            
            # Giáº£i nÃ©n
            mkdir rootfs && tar xzf debian-bookworm-arm64.tar.gz -C rootfs
            
            # Sá»­ dá»¥ng (vá»›i QEMU cho cross-arch)
            sudo chroot rootfs /bin/bash
            
            # Kiá»ƒm tra lá»‡nh cÆ¡ báº£n
            ls /usr/bin
            apt update
            dpkg --version
            ```
            
            ---
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}  
            **Total Builds:** 42 variants
            
            **Support Matrix:**
            - Debian 9-10: `amd64` `i386` `arm64` `armhf` `armel` `armv7l` (6 archs)
            - Debian 11-15: `amd64` `i386` `arm64` `armhf` `armv7l` (5 archs)
            
            **Note:** `armel` only available for Debian 9-10 (archived versions)
            
            **Important:** For ARM architectures, you need QEMU user emulation:
            ```bash
            sudo apt-get install qemu-user-static
            ```
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
