name: Build Debian
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Debian ${{ matrix.debian }} - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Debian 9 (Stretch) - Full support including old archs
          - debian: stretch
            arch: amd64
          - debian: stretch
            arch: i386
          - debian: stretch
            arch: armhf
          - debian: stretch
            arch: armel
          - debian: stretch
            arch: arm64
          - debian: stretch
            arch: armv7l
          
          # Debian 10 (Buster) - Full support including old archs
          - debian: buster
            arch: amd64
          - debian: buster
            arch: i386
          - debian: buster
            arch: armhf
          - debian: buster
            arch: armel
          - debian: buster
            arch: arm64
          - debian: buster
            arch: armv7l
          
          # Debian 11 (Bullseye) - NO armel support
          - debian: bullseye
            arch: amd64
          - debian: bullseye
            arch: i386
          - debian: bullseye
            arch: armhf
          - debian: bullseye
            arch: arm64
          - debian: bullseye
            arch: armv7l
          
          # Debian 12 (Bookworm) - NO armel support
          - debian: bookworm
            arch: amd64
          - debian: bookworm
            arch: i386
          - debian: bookworm
            arch: armhf
          - debian: bookworm
            arch: arm64
          - debian: bookworm
            arch: armv7l
          
          # Debian 13 (Trixie) - NO armel support
          - debian: trixie
            arch: amd64
          - debian: trixie
            arch: i386
          - debian: trixie
            arch: armhf
          - debian: trixie
            arch: arm64
          - debian: trixie
            arch: armv7l
          
          # Debian 14 (Forky) - Latest archs only
          - debian: forky
            arch: amd64
          - debian: forky
            arch: i386
          - debian: forky
            arch: armhf
          - debian: forky
            arch: arm64
          - debian: forky
            arch: armv7l
          
          # Debian 15 (Sid) - Latest archs only
          - debian: sid
            arch: amd64
          - debian: sid
            arch: i386
          - debian: sid
            arch: armhf
          - debian: sid
            arch: arm64
          - debian: sid
            arch: armv7l
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support debootstrap debian-archive-keyring

      - name: Create build directory
        run: |
          mkdir -p build/${{ matrix.debian }}-${{ matrix.arch }}
          mkdir -p artifacts

      - name: Build Debian rootfs
        run: |
   
          ARCH="${{ matrix.arch }}"
   
          if [[ "$ARCH" == "armv7l" ]]; then
            ARCH="armhf"
          fi
      
          MIRROR="http://deb.debian.org/debian"
    
          if [[ "${{ matrix.debian }}" == "stretch" ]] || [[ "${{ matrix.debian }}" == "buster" ]]; then
            MIRROR="http://archive.debian.org/debian"
          fi
          
          echo "Building Debian ${{ matrix.debian }} for ${{ matrix.arch }} (debootstrap arch: $ARCH)"
          echo "Using mirror: $MIRROR"

          if [[ "${{ matrix.debian }}" == "stretch" ]] || [[ "${{ matrix.debian }}" == "buster" ]]; then
            sudo debootstrap \
              --arch=$ARCH \
              --variant=minbase \
              --include=ca-certificates,locales \
              --no-check-gpg \
              ${{ matrix.debian }} \
              build/${{ matrix.debian }}-${{ matrix.arch }} \
              $MIRROR
          else
            sudo debootstrap \
              --arch=$ARCH \
              --variant=minbase \
              --include=ca-certificates,locales \
              ${{ matrix.debian }} \
              build/${{ matrix.debian }}-${{ matrix.arch }} \
              $MIRROR
          fi

      - name: Configure rootfs
        run: |
          ROOTFS="build/${{ matrix.debian }}-${{ matrix.arch }}"
   
          sudo chroot $ROOTFS /bin/bash -c "echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen"
          sudo chroot $ROOTFS /bin/bash -c "locale-gen" || true

          sudo tee $ROOTFS/etc/build-info.txt > /dev/null <<EOF
          Debian Version: ${{ matrix.debian }}
          Architecture: ${{ matrix.arch }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Built by: GitHub Actions
          EOF

          sudo chroot $ROOTFS /bin/bash -c "apt-get clean" || true
          sudo rm -rf $ROOTFS/var/cache/apt/archives/*.deb
          sudo rm -rf $ROOTFS/tmp/*
          sudo rm -rf $ROOTFS/var/tmp/*

      - name: Create tarball
        run: |
          cd build/${{ matrix.debian }}-${{ matrix.arch }}

          sudo tar czf ../../artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz .
          
          cd ../..

          sha256sum artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz > \
            artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz.sha256

      - name: Get tarball info
        run: |
          ls -lh artifacts/
          echo "=== SHA256 Checksum ==="
          cat artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-${{ matrix.debian }}-${{ matrix.arch }}
          path: |
            artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz
            artifacts/debian-${{ matrix.debian }}-${{ matrix.arch }}.tar.gz.sha256
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find all-artifacts -name "*.tar.gz*" -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Debian Builds - Run ${{ github.run_number }}
          body: |
            # Debian 
            
            ---
            
            ## üá¨üáß English
            
            ### Supported Versions
            - **Debian 9** (Stretch) - Archived
            - **Debian 10** (Buster) - Archived
            - **Debian 11** (Bullseye) - Oldoldstable
            - **Debian 12** (Bookworm) - Oldstable
            - **Debian 13** (Trixie) - Testing
            - **Debian 14** (Forky) - Testing
            - **Debian 15** (Sid) - Unstable
            
            ### Architectures
            `amd64` `i386` `arm64` `armhf` `armel` `armv7l`
            
            ### Quick Start
            ```bash
            # Download
            wget debian-bookworm-arm64.tar.gz
            
            # Extract
            mkdir rootfs && tar xzf debian-bookworm-arm64.tar.gz -C rootfs
            
            # Use it
            sudo chroot rootfs /bin/bash
            ```
            
            ---
            
            ## üáªüá≥ Ti·∫øng Vi·ªát
            
            ### C√°c Phi√™n B·∫£n
            - **Debian 9** (Stretch) - ƒê√£ l∆∞u tr·ªØ
            - **Debian 10** (Buster) - ƒê√£ l∆∞u tr·ªØ
            - **Debian 11** (Bullseye) - Oldoldstable
            - **Debian 12** (Bookworm) - Oldstable
            - **Debian 13** (Trixie) - Testing
            - **Debian 14** (Forky) - Testing
            - **Debian 15** (Sid) - Unstable
            
            ### Ki·∫øn Tr√∫c
            `amd64` `i386` `arm64` `armhf` `armel` `armv7l`
            
            ### H∆∞·ªõng D·∫´n Nhanh
            ```bash
            # T·∫£i v·ªÅ
            wget debian-bookworm-arm64.tar.gz
            
            # Gi·∫£i n√©n
            mkdir rootfs && tar xzf debian-bookworm-arm64.tar.gz -C rootfs
            
            # S·ª≠ d·ª•ng
            sudo chroot rootfs /bin/bash
            ```
            
            ---
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}  
            **Total Builds:** 42 variants
            
            **Support Matrix:**
            - Debian 9-10: `amd64` `i386` `arm64` `armhf` `armel` `armv7l` (6 archs)
            - Debian 11-15: `amd64` `i386` `arm64` `armhf` `armv7l` (5 archs)
            
            **Note:** `armel` only available for Debian 9-10 (archived versions)
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
